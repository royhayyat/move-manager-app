<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <title>注专 砖 </title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>

    <style>
        :root { --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%); --bg-color: #f0f2f5; }
        body { background: var(--bg-color) linear-gradient(120deg, #e0c3fc 0%, #8ec5fc 100%) fixed; font-family: 'Rubik', sans-serif; min-height: 100vh; padding-bottom: 80px; -webkit-tap-highlight-color: transparent; }
        
        /* Login */
        #auth-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index: 9999; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .auth-box { background: white; padding: 30px; border-radius: 20px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        
        /* UI Components */
        .glass-card { background: rgba(255,255,255,0.95); border-radius: 16px; padding: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .kpi-card { background: white; border-radius: 12px; padding: 12px; height: 100%; box-shadow: 0 2px 8px rgba(0,0,0,0.05); text-align: center; border: 1px solid #f0f0f0; }
        .kpi-val { font-size: 1.2rem; font-weight: 700; color: #2d3436; margin-top: 5px; }
        .btn-custom { border-radius: 50px; background-image: var(--primary-gradient); color: white; border: none; padding: 10px 0; width: 100%; font-weight: 500; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
        
        /* Inputs */
        input, select { font-size: 16px !important; /* Prevents zoom on mobile */ } 
        .form-control-sm, .form-select-sm { height: 40px; border-radius: 8px; border: 1px solid #e0e0e0; padding: 5px 10px; background: #fff; }
        .form-control-sm:focus, .form-select-sm:focus { border-color: #667eea; box-shadow: none; }

        /* --- DESKTOP TABLE LAYOUT --- */
        @media (min-width: 992px) {
            .table-container { overflow-x: auto; }
            .fixed-table { table-layout: fixed; width: 100%; border-collapse: separate; border-spacing: 0 8px; }
            .fixed-table th { color: #888; font-weight: 500; font-size: 0.85rem; padding-bottom: 5px; }
            .item-row-card { background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.02); transition: transform 0.2s; }
            .item-row-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
            .item-row-card td { vertical-align: middle; padding: 10px; border-top: 1px solid #f0f0f0; border-bottom: 1px solid #f0f0f0; }
            .item-row-card td:first-child { border-left: 1px solid #f0f0f0; border-top-right-radius: 12px; border-bottom-right-radius: 12px; }
            .item-row-card td:last-child { border-right: 1px solid #f0f0f0; border-top-left-radius: 12px; border-bottom-left-radius: 12px; }
            .mobile-label { display: none; }
        }

        /* --- MOBILE CARD LAYOUT (The Big Fix) --- */
        @media (max-width: 991px) {
            .container-fluid { padding: 10px; }
            .table-main-head { display: none; } /* Hide Table Headers */

            /* Turn Table Rows into Cards */
            .fixed-table, tbody, tr, td { display: block; width: 100%; }
            
            .item-row-card {
                background: white;
                margin-bottom: 15px;
                border-radius: 16px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.05);
                border: 1px solid #f0f0f0;
                padding: 15px;
                display: flex;
                flex-wrap: wrap; /* Allows grid-like behavior */
                gap: 10px;
                position: relative;
            }

            /* 1. Name Field - Full Width & Bold */
            td[data-col="name"] { width: 100%; order: 1; padding: 0; margin-bottom: 5px; }
            td[data-col="name"] input { 
                font-weight: 700; font-size: 1.1rem !important; border: none; border-bottom: 2px solid #667eea; 
                border-radius: 0; padding: 0 0 5px 0; background: transparent;
            }
            td[data-col="name"] input:focus { border-bottom-color: #764ba2; }

            /* 2. Category & Payment - 50% width each */
            td[data-col="cat"], td[data-col="pay"] { width: 48%; order: 2; padding: 0; }
            
            /* 3. Numbers Row - Qty, Est, Real - 33% each */
            td[data-col="qty"], td[data-col="est"], td[data-col="real"] { width: 31%; order: 3; padding: 0; }
            
            /* Labels for inputs */
            .mobile-label { display: block; font-size: 0.75rem; color: #888; margin-bottom: 2px; }

            /* 4. Actions Row - Bottom */
            td[data-col="expand"], td[data-col="purchased"], td[data-col="delete"] { 
                order: 4; width: auto; padding: 0; margin-top: 10px; 
                display: flex; align-items: center; justify-content: center;
            }
            
            /* Specific Alignments */
            td[data-col="expand"] { flex-grow: 1; justify-content: flex-start; } /* Left */
            td[data-col="purchased"] { margin-right: auto; margin-left: 15px; } /* Center-Right */
            td[data-col="delete"] { justify-content: flex-end; } /* Right */

            /* Sub Items Container Mobile Fix */
            .sub-items-container { margin: 0; border: none; background: #fcfcfc; border-top: 1px dashed #ddd; }
        }

        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 10px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .calculated-field { background-color: #e9ecef !important; color: #495057; }
    </style>
</head>
<body>

<div id="auth-screen">
    <div class="auth-box">
        <h2 class="mb-4 text-primary fw-bold"> 注专 砖</h2>
        <div id="login-form">
            <input type="email" id="email" class="form-control mb-3 p-3" placeholder="">
            <input type="password" id="password" class="form-control mb-4 p-3" placeholder="住住">
            <button class="btn btn-custom" onclick="handleAuth('login')">转专</button>
            <div class="mt-4 small">砖 ? <a href="#" onclick="toggleMode()" class="fw-bold">爪专 砖</a></div>
        </div>
        <div id="register-form" style="display:none">
            <input type="email" id="reg-email" class="form-control mb-3 p-3" placeholder="">
            <input type="password" id="reg-pass" class="form-control mb-4 p-3" placeholder="住住 (6+ 转)">
            <button class="btn btn-custom" onclick="handleAuth('register')">专砖</button>
            <div class="mt-4 small">专砖 专? <a href="#" onclick="toggleMode()" class="fw-bold">转专</a></div>
        </div>
        <div class="loader" id="auth-loader"></div>
        <div id="auth-msg" class="text-danger mt-3 small fw-bold"></div>
    </div>
</div>

<div class="container-fluid" id="app-content" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-3 mt-3 px-2">
        <div><h4 class="mb-0 fw-bold">注专 砖</h4><small class="text-muted" style="font-size: 0.75rem" id="user-display"></small></div>
        <button class="btn btn-light btn-sm rounded-circle shadow-sm" style="width:35px;height:35px" onclick="logout()"><i class="fa-solid fa-right-from-bracket text-danger"></i></button>
    </div>

    <ul class="nav nav-pills nav-fill mb-3" id="pills-tab">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-items"> 爪</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-tasks"> 砖转</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="tab-items">
            <div class="row g-2 mb-3">
                <div class="col-6"><div class="kpi-card"><div class="small text-muted">转拽爪 砖注专</div><div class="kpi-val" id="kpi-est">0</div></div></div>
                <div class="col-6"><div class="kpi-card"><div class="small text-muted">爪转 驻注</div><div class="kpi-val text-success" id="kpi-real">0</div></div></div>
            </div>

            <div class="glass-card p-2">
                <div class="d-flex justify-content-between align-items-center mb-3 px-2 gap-2">
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle rounded-pill" type="button" data-bs-toggle="dropdown"><i class="fa-solid fa-filter"></i> 住</button>
                        <ul class="dropdown-menu text-end">
                            <li><a class="dropdown-item" href="#" onclick="setFilter('all')"></a></li>
                            <li><a class="dropdown-item" href="#" onclick="setFilter('purchased')">专砖 </a></li>
                            <li><a class="dropdown-item" href="#" onclick="setFilter('not_purchased')">专 专砖</a></li>
                        </ul>
                    </div>
                    <span id="current-filter-label" class="badge bg-light text-dark ms-2"></span>
                    <button class="btn btn-primary btn-sm rounded-pill px-3 shadow-sm ms-auto" onclick="addItem()">+ 驻专</button>
                </div>

                <div id="items-list" class="table-container"></div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-tasks">
            <div class="glass-card">
                <div id="calendar" class="mb-4"></div>
                <h6 class="fw-bold mb-3 border-bottom pb-2">住祝 砖</h6>
                <div class="d-flex gap-2 mb-3">
                    <input type="text" id="task-desc" class="form-control" placeholder=" 注砖转?">
                    <input type="date" id="task-date" class="form-control" style="width: 130px;">
                </div>
                <button class="btn btn-custom mb-3" onclick="addTask()">住祝 砖</button>
                <div id="tasks-list" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC_EkuSJuu2H62VthOLN3086V6GdnVuzFU",
      authDomain: "my-moving-app-b5884.firebaseapp.com",
      projectId: "my-moving-app-b5884",
      storageBucket: "my-moving-app-b5884.firebasestorage.app",
      messagingSenderId: "90331727782",
      appId: "1:90331727782:web:fb0f70ac7cae3dc2adb167"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let currentUser = null;
    let appData = { items: [], tasks: [] };
    let calendar;
    let currentFilter = 'all';

    window.toggleMode = () => { document.getElementById('login-form').style.display = document.getElementById('login-form').style.display === 'none' ? 'block' : 'none'; document.getElementById('register-form').style.display = document.getElementById('register-form').style.display === 'none' ? 'block' : 'none'; }
    window.handleAuth = async (mode) => {
        const email = document.getElementById(mode === 'login' ? 'email' : 'reg-email').value;
        const pass = document.getElementById(mode === 'login' ? 'password' : 'reg-pass').value;
        const msg = document.getElementById('auth-msg'); msg.innerText = ''; document.getElementById('auth-loader').style.display = 'block';
        try { if (mode === 'login') await signInWithEmailAndPassword(auth, email, pass); else await createUserWithEmailAndPassword(auth, email, pass); } 
        catch (error) { msg.innerText = "砖: " + error.message; document.getElementById('auth-loader').style.display = 'none'; }
    };
    window.logout = () => signOut(auth);
    onAuthStateChanged(auth, (user) => {
        document.getElementById('auth-loader').style.display = 'none';
        if (user) { currentUser = user; document.getElementById('auth-screen').style.display = 'none'; document.getElementById('app-content').style.display = 'block'; document.getElementById('user-display').innerText = user.email; initData(); } 
        else { document.getElementById('auth-screen').style.display = 'flex'; document.getElementById('app-content').style.display = 'none'; }
    });

    function initData() {
        onSnapshot(doc(db, "users", currentUser.uid), (snap) => {
            if (snap.exists()) { appData = snap.data(); if(!appData.items) appData.items = []; if(!appData.tasks) appData.tasks = []; appData.items.forEach(i => { if(!i.subItems) i.subItems = []; }); } 
            else { saveData(); }
            renderAll();
        });
        initCalendar();
    }
    async function saveData() { if (currentUser) await setDoc(doc(db, "users", currentUser.uid), appData); }

    window.addItem = () => { appData.items.unshift({ id: Date.now(), name: '', category: '专', paymentMethod: '砖专', qty: 1, est: 0, real: 0, purchased: false, subItems: [] }); saveData(); };
    window.updateItem = (id, field, val) => { const i = appData.items.find(x => x.id === id); if (i) { if(field === 'purchased') i.purchased = val; else if(['qty','est','real'].includes(field)) i[field] = Number(val); else i[field] = val; saveData(); } };
    window.deleteItem = (id) => { if(confirm('拽?')) { appData.items = appData.items.filter(x => x.id !== id); saveData(); } };
    
    window.addSubItem = (parentId) => { const p = appData.items.find(x => x.id === parentId); if(p) { if(!p.subItems) p.subItems=[]; p.subItems.push({id:Date.now(), name:'', cost:0, qty:1}); saveData(); } }
    window.updateSubItem = (parentId, subId, field, val) => { const p = appData.items.find(x => x.id === parentId); if(p&&p.subItems) { const s = p.subItems.find(x => x.id === subId); if(s) { s[field] = field==='name'?val:Number(val); saveData(); } } }
    window.deleteSubItem = (parentId, subId) => { const p = appData.items.find(x => x.id === parentId); if(p&&p.subItems) { p.subItems = p.subItems.filter(x => x.id !== subId); saveData(); } }

    window.setFilter = (f) => { currentFilter = f; document.getElementById('current-filter-label').innerText = f==='all'?'':(f==='purchased'?'专砖':'专 专砖'); renderAll(); }
    window.addTask = () => { const t = document.getElementById('task-desc').value; const d = document.getElementById('task-date').value; if(t) { appData.tasks.push({id:Date.now(), title:t, date:d, done:false}); document.getElementById('task-desc').value=''; saveData(); } };
    window.deleteTask = (id) => { appData.tasks = appData.tasks.filter(t => t.id !== id); saveData(); };
    window.toggleTask = (id) => { const t = appData.tasks.find(x => x.id === id); if(t) { t.done = !t.done; saveData(); } };

    function renderAll() {
        const list = document.getElementById('items-list');
        let filtered = appData.items;
        if (currentFilter === 'purchased') filtered = appData.items.filter(i => i.purchased);
        else if (currentFilter === 'not_purchased') filtered = appData.items.filter(i => !i.purchased);

        if(filtered.length === 0) {
            list.innerHTML = '<div class="text-center text-muted py-5"> 驻专 爪</div>';
        } else {
            list.innerHTML = `
            <table class="fixed-table m-0">
                <colgroup>
                    <col style="width: 5%;"> <col style="width: 20%;"> <col style="width: 12%;"> <col style="width: 12%;"> <col style="width: 8%;">  <col style="width: 12%;"> <col style="width: 12%;"> <col style="width: 10%;"> <col style="width: 9%;">  </colgroup>
                <thead class="table-main-head">
                    <tr><th></th><th>砖 爪专</th><th>拽专</th><th>转砖</th><th>转</th><th>爪驻</th><th>驻注</th><th class="text-center">专砖</th><th></th></tr>
                </thead>
                <tbody>
                    ${filtered.map(i => {
                        const hasSub = i.subItems && i.subItems.length > 0;
                        const realVal = hasSub ? i.subItems.reduce((a,s)=>a+(s.cost*s.qty),0) : i.real;
                        const payMethod = i.paymentMethod || '砖专';
                        
                        return `
                        <tr class="item-row-card">
                            <td data-col="name">
                                <input type="text" value="${i.name}" onchange="updateItem(${i.id},'name',this.value)" placeholder="砖 爪专...">
                            </td>
                            
                            <td data-col="cat">
                                <span class="mobile-label">拽专</span>
                                <select class="form-select form-select-sm" onchange="updateItem(${i.id},'category',this.value)">${['专','专','砖','','砖驻抓'].map(c=>`<option ${c===i.category?'selected':''}>${c}</option>`).join('')}</select>
                            </td>

                            <td data-col="pay">
                                <span class="mobile-label">转砖</span>
                                <select class="form-select form-select-sm" onchange="updateItem(${i.id},'paymentMethod',this.value)">${['砖专','','注专','','爪\'拽'].map(c=>`<option ${c===payMethod?'selected':''}>${c}</option>`).join('')}</select>
                            </td>

                            <td data-col="qty">
                                <span class="mobile-label">转</span>
                                <input type="number" class="form-control form-control-sm" value="${i.qty}" onchange="updateItem(${i.id},'qty',this.value)" ${hasSub?'disabled':''}>
                            </td>

                            <td data-col="est">
                                <span class="mobile-label">爪驻</span>
                                <input type="number" class="form-control form-control-sm" value="${i.est}" onchange="updateItem(${i.id},'est',this.value)">
                            </td>

                            <td data-col="real">
                                <span class="mobile-label">驻注</span>
                                <input type="number" class="form-control form-control-sm ${hasSub?'calculated-field':''}" value="${realVal}" onchange="updateItem(${i.id},'real',this.value)" ${hasSub?'readonly':''}>
                            </td>

                            <td data-col="expand">
                                <button class="btn btn-sm btn-outline-primary border-0" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${i.id}">
                                    <i class="fa-solid fa-list-ul"></i> ${hasSub ? ' 驻专' : ' 住祝 驻专'}
                                </button>
                            </td>

                            <td data-col="purchased">
                                <div class="form-check form-switch"><input class="form-check-input" type="checkbox" style="width:40px;height:20px" ${i.purchased?'checked':''} onchange="updateItem(${i.id},'purchased',this.checked)"></div>
                            </td>

                            <td data-col="delete">
                                <button class="btn btn-sm text-danger border-0" onclick="deleteItem(${i.id})"><i class="fa-solid fa-trash"></i></button>
                            </td>
                        </tr>
                        
                        <tr>
                            <td colspan="9" class="p-0 border-0">
                                <div class="collapse" id="collapse-${i.id}">
                                    <div class="sub-items-container">
                                        <div class="d-flex justify-content-between mb-2">
                                            <small class="fw-bold">专 注转:</small>
                                            <button class="btn btn-sm btn-primary py-0" onclick="addSubItem(${i.id})">+ 住祝</button>
                                        </div>
                                        ${(i.subItems||[]).map(s => `
                                            <div class="row g-1 mb-2 align-items-center">
                                                <div class="col-5"><input type="text" class="form-control form-control-sm" value="${s.name}" placeholder="砖" onchange="updateSubItem(${i.id},${s.id},'name',this.value)"></div>
                                                <div class="col-2"><input type="number" class="form-control form-control-sm px-1" value="${s.qty}" onchange="updateSubItem(${i.id},${s.id},'qty',this.value)"></div>
                                                <div class="col-3"><input type="number" class="form-control form-control-sm px-1" value="${s.cost}" onchange="updateSubItem(${i.id},${s.id},'cost',this.value)"></div>
                                                <div class="col-2 text-center"><i class="fa-solid fa-xmark text-danger" style="cursor:pointer" onclick="deleteSubItem(${i.id},${s.id})"></i></div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </td>
                        </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>`;
        }

        let tEst = 0, tReal = 0;
        appData.items.forEach(i => {
            tEst += (i.est * i.qty);
            const real = (i.subItems&&i.subItems.length>0) ? i.subItems.reduce((a,s)=>a+(s.cost*s.qty),0) : (i.real*i.qty);
            tReal += real;
        });
        document.getElementById('kpi-est').innerText = tEst.toLocaleString();
        document.getElementById('kpi-real').innerText = tReal.toLocaleString();
        
        document.getElementById('tasks-list').innerHTML = appData.tasks.map(t => `
            <div class="glass-card p-2 mb-2 d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-2">
                    <input type="checkbox" class="form-check-input" ${t.done?'checked':''} onchange="toggleTask(${t.id})">
                    <div><div class="${t.done?'text-decoration-line-through text-muted':''} fw-bold">${t.title}</div><div class="small text-muted">${t.date||''}</div></div>
                </div>
                <button class="btn btn-sm text-danger" onclick="deleteTask(${t.id})"><i class="fa-solid fa-xmark"></i></button>
            </div>`).join('');
            
        if(calendar) { calendar.removeAllEvents(); calendar.addEventSource(appData.tasks.filter(t=>t.date).map(t => ({ title: t.title, start: t.date, color: t.done?'#ccc':'#667eea' }))); }
    }

    function initCalendar() {
        if(calendar) return;
        const isMobile = window.innerWidth < 992;
        calendar = new FullCalendar.Calendar(document.getElementById('calendar'), { initialView: isMobile?'listMonth':'dayGridMonth', headerToolbar: {left:'prev,next',center:'title',right:''}, height:'auto', direction:'rtl', locale:'he', buttonText:{list:'专砖'} });
        calendar.render();
    }
    document.querySelector('button[data-bs-target="#tab-tasks"]').addEventListener('shown.bs.tab', () => calendar && calendar.render());
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
