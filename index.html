<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <title>注专 砖 </title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>

    <style>
        :root { --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%); --bg-color: #f0f2f5; }
        body { background: var(--bg-color) linear-gradient(120deg, #e0c3fc 0%, #8ec5fc 100%) fixed; font-family: 'Rubik', sans-serif; min-height: 100vh; padding-bottom: 80px; -webkit-tap-highlight-color: transparent; }
        
        /* Login Screen */
        #auth-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index: 9999; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .auth-box { background: white; padding: 30px; border-radius: 20px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        
        /* Cards & Buttons */
        .glass-card { background: rgba(255,255,255,0.98); border-radius: 16px; padding: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .kpi-card { background: white; border-radius: 12px; padding: 12px; height: 100%; box-shadow: 0 2px 8px rgba(0,0,0,0.05); text-align: center; border: 1px solid #f0f0f0; }
        .kpi-val { font-size: 1.2rem; font-weight: 700; color: #2d3436; margin-top: 5px; }
        .btn-custom { border-radius: 50px; background-image: var(--primary-gradient); color: white; border: none; padding: 10px 0; width: 100%; font-weight: 500; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
        .nav-pills .nav-link { border-radius: 50px; margin: 0 5px; font-size: 0.9rem; transition: all 0.3s; }
        .nav-pills .nav-link.active { background: var(--primary-gradient); box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }

        /* --- Mobile Table Fixes --- */
        @media (max-width: 768px) {
            .container-fluid { padding: 12px; }
            
            /* Hide headers */
            .table thead { display: none; }
            .table, .table tbody, .table tr, .table td { display: block; width: 100%; }
            
            /* Card Style for Rows */
            .table tr {
                background: white;
                margin-bottom: 20px; /* More space between cards */
                border-radius: 16px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.03);
                border: 1px solid #f0f0f0;
                padding: 15px 15px 50px 15px; /* Added bottom padding for the delete button */
                position: relative; /* For absolute positioning of delete button */
            }
            
            .table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                text-align: left;
                padding: 8px 0;
                border-bottom: 1px solid #f9f9f9;
            }
            .table td:last-child { border-bottom: none; display: block; padding: 0; }
            
            /* Labels */
            .table td::before {
                content: attr(data-label);
                font-weight: 600;
                font-size: 0.9rem;
                color: #636e72;
                margin-left: 15px;
                min-width: 80px; /* Ensure label has space */
            }
            
            /* Input fields */
            .table input, .table select {
                text-align: right; /* Text aligns right (Hebrew friendly) */
                background: #f8f9fa !important;
                border-radius: 8px;
                padding: 8px 12px;
                width: 100% !important; 
                flex: 1; /* Take remaining space */
                font-size: 0.95rem;
                border: 1px solid #eee !important;
            }
            .table input:focus { background: white !important; border-color: #667eea !important; }

            /* Checkbox special styling */
            .table td[data-label=" 专砖?"] { justify-content: space-between; }
            .table td[data-label=" 专砖?"] .form-check { margin: 0; }

            /* Delete Button - Moved to Bottom Left */
            .btn-delete-mobile {
                position: absolute;
                bottom: 10px; /* Bottom instead of top */
                left: 15px;   /* Left corner */
                background: #ffecec;
                color: #ff7675;
                border-radius: 12px;
                width: auto; 
                height: 35px;
                padding: 0 15px;
                display: flex; align-items: center; justify-content: center;
                font-size: 0.9rem;
                font-weight: 500;
                box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            }
            .btn-delete-mobile::after { content: " 拽"; margin-right: 5px; } /* Add text label */
        }

        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 10px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fc-toolbar-title { font-size: 1.1rem !important; }
        .fc-button { font-size: 0.8rem !important; padding: 4px 8px !important; }
    </style>
</head>
<body>

<div id="auth-screen">
    <div class="auth-box">
        <h2 class="mb-4 text-primary fw-bold"> 注专 砖</h2>
        <div id="login-form">
            <input type="email" id="email" class="form-control mb-3 p-3" placeholder="">
            <input type="password" id="password" class="form-control mb-4 p-3" placeholder="住住">
            <button class="btn btn-custom" onclick="handleAuth('login')">转专</button>
            <div class="mt-4 small">砖 ? <a href="#" onclick="toggleMode()" class="fw-bold">爪专 砖</a></div>
        </div>
        <div id="register-form" style="display:none">
            <input type="email" id="reg-email" class="form-control mb-3 p-3" placeholder="">
            <input type="password" id="reg-pass" class="form-control mb-4 p-3" placeholder="住住 (6+ 转)">
            <button class="btn btn-custom" onclick="handleAuth('register')">专砖</button>
            <div class="mt-4 small">专砖 专? <a href="#" onclick="toggleMode()" class="fw-bold">转专</a></div>
        </div>
        <div class="loader" id="auth-loader"></div>
        <div id="auth-msg" class="text-danger mt-3 small fw-bold"></div>
    </div>
</div>

<div class="container-fluid" id="app-content" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-3 mt-3 px-2">
        <div><h4 class="mb-0 fw-bold">注专 砖</h4><small class="text-muted" style="font-size: 0.75rem" id="user-display"></small></div>
        <button class="btn btn-light btn-sm rounded-circle shadow-sm" style="width:35px;height:35px" onclick="logout()"><i class="fa-solid fa-right-from-bracket text-danger"></i></button>
    </div>

    <ul class="nav nav-pills nav-fill mb-3" id="pills-tab">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-items"> 爪</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-tasks"> 砖转</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="tab-items">
            <div class="row g-2 mb-3">
                <div class="col-6"><div class="kpi-card"><div class="small text-muted">转拽爪</div><div class="kpi-val" id="kpi-est">0</div></div></div>
                <div class="col-6"><div class="kpi-card"><div class="small text-muted">驻注</div><div class="kpi-val text-success" id="kpi-real">0</div></div></div>
            </div>

            <div class="glass-card p-2">
                <div class="d-flex justify-content-between align-items-center mb-3 px-2">
                    <span class="fw-bold small text-muted"><i class="fa-solid fa-list"></i> 专砖转 驻专</span>
                    <button class="btn btn-primary btn-sm rounded-pill px-3 shadow-sm" onclick="addItem()">+ 砖</button>
                </div>
                <div id="items-list"></div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-tasks">
            <div class="glass-card">
                <div id="calendar" class="mb-4"></div>
                <h6 class="fw-bold mb-3 border-bottom pb-2">住祝 砖</h6>
                <div class="d-flex gap-2 mb-3">
                    <input type="text" id="task-desc" class="form-control" placeholder=" 注砖转?">
                    <input type="date" id="task-date" class="form-control" style="width: 130px;">
                </div>
                <button class="btn btn-custom mb-3" onclick="addTask()">住祝 砖</button>
                <div id="tasks-list" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAWq3sTNwwyJyJQtCQQPAOYm4iYhYQ7hdg",
      authDomain: "move-manager-app.firebaseapp.com",
      projectId: "move-manager-app",
      storageBucket: "move-manager-app.firebasestorage.app",
      messagingSenderId: "285359561526",
      appId: "1:285359561526:web:da34ac43a6e75606703197"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let currentUser = null;
    let appData = { items: [], tasks: [] };
    let calendar;

    // Auth
    window.toggleMode = () => {
        const login = document.getElementById('login-form');
        const reg = document.getElementById('register-form');
        login.style.display = login.style.display === 'none' ? 'block' : 'none';
        reg.style.display = reg.style.display === 'none' ? 'block' : 'none';
    }
    window.handleAuth = async (mode) => {
        const email = document.getElementById(mode === 'login' ? 'email' : 'reg-email').value;
        const pass = document.getElementById(mode === 'login' ? 'password' : 'reg-pass').value;
        const msg = document.getElementById('auth-msg');
        const loader = document.getElementById('auth-loader');
        msg.innerText = ''; loader.style.display = 'block';
        try {
            if (mode === 'login') await signInWithEmailAndPassword(auth, email, pass);
            else await createUserWithEmailAndPassword(auth, email, pass);
        } catch (error) {
            msg.innerText = "砖: " + error.message;
            loader.style.display = 'none';
        }
    };
    window.logout = () => signOut(auth);
    onAuthStateChanged(auth, (user) => {
        document.getElementById('auth-loader').style.display = 'none';
        if (user) {
            currentUser = user;
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
            document.getElementById('user-display').innerText = user.email;
            initData();
        } else {
            document.getElementById('auth-screen').style.display = 'flex';
            document.getElementById('app-content').style.display = 'none';
        }
    });

    // Data
    function initData() {
        onSnapshot(doc(db, "users", currentUser.uid), (snap) => {
            if (snap.exists()) {
                appData = snap.data();
                if(!appData.items) appData.items = [];
                if(!appData.tasks) appData.tasks = [];
            } else { saveData(); }
            renderAll();
        });
        initCalendar();
    }
    async function saveData() {
        if (!currentUser) return;
        await setDoc(doc(db, "users", currentUser.uid), appData);
    }

    // Actions
    window.addItem = () => { appData.items.unshift({ id: Date.now(), name: '', category: '专', qty: 1, est: 0, real: 0, purchased: false }); saveData(); };
    window.updateItem = (id, field, val) => {
        const i = appData.items.find(x => x.id === id);
        if (i) {
            i[field] = field === 'purchased' ? val : (['qty','est','real'].includes(field) ? Number(val) : val);
            saveData();
        }
    };
    window.deleteItem = (id) => { if(confirm('拽?')) { appData.items = appData.items.filter(x => x.id !== id); saveData(); } };
    window.addTask = () => {
        const title = document.getElementById('task-desc').value;
        const date = document.getElementById('task-date').value;
        if(title) { appData.tasks.push({ id: Date.now(), title, date, done: false }); document.getElementById('task-desc').value = ''; saveData(); }
    };
    window.deleteTask = (id) => { appData.tasks = appData.tasks.filter(t => t.id !== id); saveData(); };
    window.toggleTask = (id) => { const t = appData.tasks.find(x => x.id === id); if(t) { t.done = !t.done; saveData(); } };

    // Render
    function renderAll() {
        const list = document.getElementById('items-list');
        if(appData.items.length === 0) {
            list.innerHTML = '<div class="text-center text-muted py-5"> 驻专 注</div>';
        } else {
            list.innerHTML = `
            <table class="table table-borderless m-0">
                <thead class="text-muted small bg-light rounded d-none d-md-table-header-group">
                    <tr><th>砖</th><th width="80">拽专</th><th width="60">转</th><th width="80">爪驻</th><th width="80">驻注</th><th width="50">专砖</th><th></th></tr>
                </thead>
                <tbody>
                    ${appData.items.map(i => `
                    <tr>
                        <td data-label="砖 爪专"><input class="form-control form-control-sm border-0 bg-light" value="${i.name}" onchange="updateItem(${i.id},'name',this.value)" placeholder="住 砖..."></td>
                        <td data-label="拽专"><select class="form-select form-select-sm border-0 bg-light" onchange="updateItem(${i.id},'category',this.value)">${['专','砖','','专'].map(c=>`<option ${c===i.category?'selected':''}>${c}</option>`).join('')}</select></td>
                        <td data-label="转"><input type="number" class="form-control form-control-sm border-0 bg-light" value="${i.qty}" onchange="updateItem(${i.id},'qty',this.value)"></td>
                        <td data-label="专 砖注专"><input type="number" class="form-control form-control-sm border-0 bg-light" value="${i.est}" onchange="updateItem(${i.id},'est',this.value)"></td>
                        <td data-label="专 驻注"><input type="number" class="form-control form-control-sm border-0 bg-light" value="${i.real}" onchange="updateItem(${i.id},'real',this.value)"></td>
                        <td data-label=" 专砖?"><div class="form-check d-flex justify-content-end justify-content-md-start"><input type="checkbox" class="form-check-input" ${i.purchased?'checked':''} onchange="updateItem(${i.id},'purchased',this.checked)"></div></td>
                        <td class="text-end" style="border:none !important">
                            <button class="btn btn-delete-mobile d-md-none" onclick="deleteItem(${i.id})"><i class="fa-solid fa-trash"></i></button>
                            <i class="fa-solid fa-trash text-danger d-none d-md-inline" style="cursor:pointer" onclick="deleteItem(${i.id})"></i>
                        </td>
                    </tr>
                    `).join('')}
                </tbody>
            </table>`;
        }

        const est = appData.items.reduce((s,i) => s + (i.est * i.qty), 0);
        const real = appData.items.filter(i=>i.purchased).reduce((s,i) => s + (i.real * i.qty), 0);
        document.getElementById('kpi-est').innerText = est.toLocaleString();
        document.getElementById('kpi-real').innerText = real.toLocaleString();

        document.getElementById('tasks-list').innerHTML = appData.tasks.map(t => `
            <div class="glass-card p-2 mb-2 d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-2">
                    <input type="checkbox" class="form-check-input" ${t.done?'checked':''} onchange="toggleTask(${t.id})">
                    <div>
                        <div class="${t.done?'text-decoration-line-through text-muted':''} fw-bold">${t.title}</div>
                        <div class="small text-muted">${t.date||''}</div>
                    </div>
                </div>
                <button class="btn btn-sm text-danger" onclick="deleteTask(${t.id})"><i class="fa-solid fa-xmark"></i></button>
            </div>
        `).join('');

        if(calendar) {
            calendar.removeAllEvents();
            calendar.addEventSource(appData.tasks.filter(t=>t.date).map(t => ({ title: t.title, start: t.date, color: t.done?'#ccc':'#667eea' })));
        }
    }

    function initCalendar() {
        if(calendar) return;
        const isMobile = window.innerWidth < 768;
        calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
            initialView: isMobile ? 'listMonth' : 'dayGridMonth',
            headerToolbar: { left: 'prev,next', center: 'title', right: '' },
            height: 'auto', direction: 'rtl', locale: 'he',
            buttonText: { list: '专砖' }
        });
        calendar.render();
    }
    document.querySelector('button[data-bs-target="#tab-tasks"]').addEventListener('shown.bs.tab', () => calendar && calendar.render());

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
