<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×”××¢×‘×¨ ×©×œ×™ ğŸ  - ××—×•×‘×¨ ×œ×¢× ×Ÿ</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-color: #f0f2f5;
        }
        body {
            background-color: var(--bg-color);
            background-image: linear-gradient(120deg, #e0c3fc 0%, #8ec5fc 100%);
            background-attachment: fixed;
            font-family: 'Rubik', sans-serif;
            min-height: 100vh;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            backdrop-filter: blur(10px);
        }
        
        /* ××¡×š ×”×ª×—×‘×¨×•×ª */
        #auth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
        .auth-box {
            background: white; padding: 40px; border-radius: 20px;
            width: 100%; max-width: 400px; text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }
        #app-content { display: none; } /* ××•×¡×ª×¨ ×¢×“ ×œ×”×ª×—×‘×¨×•×ª */

        .kpi-card { background: white; border-radius: 16px; padding: 15px; height: 100%; transition: transform 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .kpi-card:hover { transform: translateY(-5px); }
        .kpi-value { font-size: 1.5rem; font-weight: bold; color: #333; }
        .nav-pills .nav-link.active { background: var(--primary-gradient); }
        .table-container { background: white; border-radius: 20px; padding: 20px; }
        .btn-custom { border-radius: 50px; background-image: var(--primary-gradient); color: white; border: none; }
        
        /* Spinner */
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #6c5ce7; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* ×”×ª×××•×ª ×œ×™×•××Ÿ */
        .fc-toolbar-title { font-size: 1.2rem !important; }
        .fc-button { font-size: 0.8rem !important; }
    </style>
</head>
<body>

<div id="auth-overlay">
    <div class="auth-box">
        <h2 class="mb-4 text-primary fw-bold"><i class="fa-solid fa-cloud"></i> ×”××¢×‘×¨ ×©×œ×™</h2>
        <div id="auth-forms">
            <div id="login-form">
                <h5 class="mb-3">×”×ª×—×‘×¨×•×ª</h5>
                <input type="email" id="login-email" class="form-control mb-2" placeholder="××™××™×™×œ">
                <input type="password" id="login-pass" class="form-control mb-3" placeholder="×¡×™×¡××”">
                <button class="btn btn-custom w-100 mb-3" onclick="loginUser()">×”×›× ×¡</button>
                <p class="small">××™×Ÿ ×œ×š ×—×©×‘×•×Ÿ? <a href="#" onclick="toggleAuth('register')">×”×¨×©× ×›××Ÿ</a></p>
            </div>
            
            <div id="register-form" style="display: none;">
                <h5 class="mb-3">×”×¨×©××” ×—×“×©×”</h5>
                <input type="email" id="reg-email" class="form-control mb-2" placeholder="××™××™×™×œ">
                <input type="password" id="reg-pass" class="form-control mb-3" placeholder="×¡×™×¡××” (×œ×¤×—×•×ª 6 ×ª×•×•×™×)">
                <button class="btn btn-custom w-100 mb-3" onclick="registerUser()">×¦×•×¨ ×—×©×‘×•×Ÿ</button>
                <p class="small">×™×© ×œ×š ×—×©×‘×•×Ÿ? <a href="#" onclick="toggleAuth('login')">×”×ª×—×‘×¨ ×›××Ÿ</a></p>
            </div>
            
            <div class="loader" id="auth-loader"></div>
            <div id="auth-error" class="text-danger mt-2 small"></div>
        </div>
    </div>
</div>

<div id="app-content" class="container-fluid p-4">
    <header class="glass-card d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-0"><i class="fa-solid fa-truck-ramp-box text-primary me-2"></i> ×”××¢×‘×¨ ×©×œ×™</h2>
            <p class="text-muted small mb-0 mt-1">××—×•×‘×¨ ×›: <span id="user-email-display" class="fw-bold"></span></p>
        </div>
        <div>
            <button class="btn btn-outline-danger btn-sm rounded-pill" onclick="logoutUser()">×”×ª× ×ª×§ <i class="fa-solid fa-right-from-bracket"></i></button>
        </div>
    </header>

    <ul class="nav nav-pills mb-4 justify-content-center" id="pills-tab" role="tablist">
        <li class="nav-item"><button class="nav-link active rounded-pill px-4" data-bs-toggle="pill" data-bs-target="#pills-inventory">×¦×™×•×“ ×•×ª×§×¦×™×‘</button></li>
        <li class="nav-item"><button class="nav-link rounded-pill px-4 me-2" data-bs-toggle="pill" data-bs-target="#pills-tasks">××©×™××•×ª ×•×™×•××Ÿ</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="pills-inventory">
             <section class="row g-3 mb-4">
                <div class="col-md-2 col-6"><div class="kpi-card"><div class="small text-muted">×ª×§×¦×™×‘ ××©×•×¢×¨</div><div class="kpi-value" id="kpi-est">0 â‚ª</div></div></div>
                <div class="col-md-2 col-6"><div class="kpi-card"><div class="small text-muted">×‘×¤×•×¢×œ</div><div class="kpi-value text-success" id="kpi-real">0 â‚ª</div></div></div>
                <div class="col-md-2 col-6"><div class="kpi-card"><div class="small text-muted">×”×¤×¨×©</div><div class="kpi-value" id="kpi-diff">0 â‚ª</div></div></div>
                <div class="col-md-2 col-6"><div class="kpi-card"><div class="small text-muted">× ×¨×›×©×•</div><div class="kpi-value" id="kpi-count">0</div></div></div>
                <div class="col-md-4 col-12">
                    <div class="kpi-card">
                         <div class="d-flex justify-content-between small text-muted"><span>×”×ª×§×“××•×ª</span><span id="prog-text">0%</span></div>
                         <div class="progress mt-1" style="height: 8px;"><div id="prog-bar" class="progress-bar bg-warning" style="width: 0%"></div></div>
                         <div class="mt-2 d-flex justify-content-between align-items-center">
                             <small>××§×“××•×ª:</small>
                             <input type="number" id="down-payment" class="form-control border-0 p-0 text-end fw-bold text-primary" style="width: 80px; background:transparent" value="0" onchange="saveDataToCloud()">
                         </div>
                    </div>
                </div>
            </section>

            <div class="glass-card mb-3 d-flex gap-2 align-items-center">
                <button class="btn btn-primary btn-sm rounded-pill" onclick="addNewRow()"><i class="fa-solid fa-plus"></i> ×”×•×¡×£ ×¤×¨×™×˜</button>
                <button class="btn btn-outline-danger btn-sm rounded-pill" onclick="deleteSelected()"><i class="fa-solid fa-trash"></i></button>
                <div class="ms-auto" id="cloud-status"><i class="fa-solid fa-cloud-arrow-up text-muted"></i></div>
            </div>

            <div class="table-container table-responsive">
                <table class="table align-middle mb-0" id="items-table">
                    <thead>
                        <tr>
                            <th width="30"><input type="checkbox" id="select-all"></th>
                            <th>××•×¦×¨</th>
                            <th width="100">×§×˜×’×•×¨×™×”</th>
                            <th width="60">×›××•×ª</th>
                            <th width="90">×¦×¤×™</th>
                            <th width="90">×‘×¤×•×¢×œ</th>
                            <th>×¡×¤×§</th>
                            <th width="40" title="× ×¨×›×©?">V</th>
                            <th width="40"></th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>

        <div class="tab-pane fade" id="pills-tasks">
            <div class="row g-4">
                <div class="col-lg-8"><div class="glass-card"><div id="calendar"></div></div></div>
                <div class="col-lg-4">
                    <div class="glass-card h-100">
                        <h5>××©×™××•×ª</h5>
                        <div class="input-group mb-2">
                            <input type="text" id="task-input" class="form-control" placeholder="××©×™××” ×—×“×©×”...">
                            <input type="date" id="task-date" class="form-control" style="max-width: 130px;">
                            <button class="btn btn-primary" onclick="addTask()">+</button>
                        </div>
                        <div id="task-list" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- ×”×§×•× ×¤×™×’×•×¨×¦×™×” ×©×œ×š ×-Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyAWq3sTNwwyJyJQtCQQPAOYm4iYhYQ7hdg",
      authDomain: "move-manager-app.firebaseapp.com",
      projectId: "move-manager-app",
      storageBucket: "move-manager-app.firebasestorage.app",
      messagingSenderId: "285359561526",
      appId: "1:285359561526:web:da34ac43a6e75606703197"
    };

    // ××ª×—×•×œ Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let appData = { items: [], tasks: [], payment: 0 };
    let calendar = null;

    // --- ×œ×•×’×™×§×ª ××©×ª××©×™× (Auth) ---

    window.toggleAuth = (mode) => {
        document.getElementById('login-form').style.display = mode === 'login' ? 'block' : 'none';
        document.getElementById('register-form').style.display = mode === 'register' ? 'block' : 'none';
        document.getElementById('auth-error').innerText = '';
    };

    window.registerUser = async () => {
        const email = document.getElementById('reg-email').value;
        const pass = document.getElementById('reg-pass').value;
        toggleLoader(true);
        try {
            await createUserWithEmailAndPassword(auth, email, pass);
            // ×”×¦×œ×—×” - ×”××©×ª××© ××—×•×‘×¨ ××•×˜×•××˜×™×ª
        } catch (error) {
            let msg = "×©×’×™××” ×‘×”×¨×©××”";
            if(error.code === 'auth/email-already-in-use') msg = "×”××™×™×œ ×”×–×” ×›×‘×¨ ×§×™×™× ×‘××¢×¨×›×ª";
            if(error.code === 'auth/weak-password') msg = "×”×¡×™×¡××” ×—×œ×©×” ××“×™ (××™× ×™××•× 6 ×ª×•×•×™×)";
            document.getElementById('auth-error').innerText = msg;
            toggleLoader(false);
        }
    };

    window.loginUser = async () => {
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-pass').value;
        toggleLoader(true);
        try {
            await signInWithEmailAndPassword(auth, email, pass);
        } catch (error) {
            document.getElementById('auth-error').innerText = "×¤×¨×˜×™× ×©×’×•×™×™× ××• ×‘×¢×™×™×ª ×”×ª×—×‘×¨×•×ª";
            toggleLoader(false);
        }
    };

    window.logoutUser = () => signOut(auth);

    function toggleLoader(show) {
        document.getElementById('auth-loader').style.display = show ? 'block' : 'none';
    }

    // --- ×”××–× ×” ×œ××¦×‘ ×”×ª×—×‘×¨×•×ª ---
    onAuthStateChanged(auth, (user) => {
        toggleLoader(false);
        if (user) {
            currentUser = user;
            document.getElementById('auth-overlay').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
            document.getElementById('user-email-display').innerText = user.email;
            initApp(); // ×˜×¢×Ÿ × ×ª×•× ×™×
        } else {
            currentUser = null;
            document.getElementById('auth-overlay').style.display = 'flex';
            document.getElementById('app-content').style.display = 'none';
        }
    });

    // --- ×¡× ×›×¨×•×Ÿ × ×ª×•× ×™× (Firestore) ---

    function initApp() {
        // ×”××–× ×” ×‘×–××Ÿ ×××ª ×œ×©×™× ×•×™×™× ×‘-DB ×¢×‘×•×¨ ×”××©×ª××© ×”×–×” ×‘×œ×‘×“
        const userDocRef = doc(db, "users", currentUser.uid);
        
        onSnapshot(userDocRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                appData = data;
                if(!appData.items) appData.items = [];
                if(!appData.tasks) appData.tasks = [];
                document.getElementById('down-payment').value = appData.payment || 0;
            } else {
                // ××©×ª××© ×—×“×© - × ×™×¦×•×¨ ×œ×• ××¡××š ×¨×™×§
                appData = { items: [], tasks: [], payment: 0 };
                saveDataToCloud();
            }
            renderAll();
        });

        initCalendar();
    }

    window.saveDataToCloud = async () => {
        if (!currentUser) return;
        document.getElementById('cloud-status').innerHTML = '<i class="fa-solid fa-spinner fa-spin text-primary"></i>';
        
        appData.payment = document.getElementById('down-payment').value;
        
        try {
            await setDoc(doc(db, "users", currentUser.uid), appData);
            setTimeout(() => {
                document.getElementById('cloud-status').innerHTML = '<i class="fa-solid fa-check text-success"></i>';
            }, 500);
        } catch (e) {
            console.error("Error saving", e);
            document.getElementById('cloud-status').innerHTML = '<i class="fa-solid fa-triangle-exclamation text-danger"></i>';
        }
    };

    // --- ×œ×•×’×™×§×ª ×”××¤×œ×™×§×¦×™×” (×¤×¨×™×˜×™×) ---

    window.addNewRow = () => {
        appData.items.unshift({ id: Date.now(), name: '', category: '××—×¨', qty: 1, est: 0, real: 0, vendor: '', purchased: false });
        saveDataToCloud();
    };

    window.updateItem = (id, field, value) => {
        const item = appData.items.find(i => i.id === id);
        if (item) {
            if(['qty','est','real'].includes(field)) value = parseFloat(value) || 0;
            if(field === 'purchased') value = !!value; 
            item[field] = value;
            saveDataToCloud(); 
        }
    };

    window.deleteSelected = () => {
        const checked = document.querySelectorAll('.row-chk:checked');
        if (checked.length && confirm('×œ××—×•×§?')) {
            const ids = Array.from(checked).map(c => +c.value);
            appData.items = appData.items.filter(i => !ids.includes(i.id));
            saveDataToCloud();
        }
    };

    function renderAll() {
        renderTable();
        renderKPIs();
        renderTasks();
        if(calendar) {
            calendar.removeAllEvents();
            // ××•×¡×™×£ ××©×™××•×ª ×œ×™×•××Ÿ
            calendar.addEventSource(appData.tasks.filter(t=>t.date).map(t => ({ 
                title: t.title, 
                start: t.date, 
                allDay: true,
                color: t.done ? '#ccc' : '#667eea'
            })));
        }
    }

    function renderTable() {
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = '';
        appData.items.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="checkbox" class="row-chk form-check-input" value="${item.id}"></td>
                <td><input type="text" class="form-control form-control-sm border-0 bg-transparent fw-bold" value="${item.name}" onchange="updateItem(${item.id}, 'name', this.value)" placeholder="×©×..."></td>
                <td><select class="form-select form-select-sm border-0 bg-transparent" onchange="updateItem(${item.id}, 'category', this.value)">
                    ${['××•×¦×¨×™ ×—×©××œ','×¨×™×”×•×˜','××˜×‘×—','××—×¨'].map(o => `<option ${o===item.category?'selected':''}>${o}</option>`).join('')}
                </select></td>
                <td><input type="number" class="form-control form-control-sm border-0 bg-transparent" value="${item.qty}" onchange="updateItem(${item.id}, 'qty', this.value)"></td>
                <td><input type="number" class="form-control form-control-sm border-0 bg-transparent" value="${item.est}" onchange="updateItem(${item.id}, 'est', this.value)"></td>
                <td><input type="number" class="form-control form-control-sm border-0 bg-transparent" value="${item.real}" onchange="updateItem(${item.id}, 'real', this.value)"></td>
                <td><input type="text" class="form-control form-control-sm border-0 bg-transparent" value="${item.vendor||''}" onchange="updateItem(${item.id}, 'vendor', this.value)"></td>
                <td><input type="checkbox" class="form-check-input" ${item.purchased?'checked':''} onchange="updateItem(${item.id}, 'purchased', this.checked)"></td>
                <td><i class="fa-solid fa-trash text-danger" style="cursor:pointer" onclick="deleteSingle(${item.id})"></i></td>
            `;
            tbody.appendChild(tr);
        });
    }

    window.deleteSingle = (id) => {
        if(confirm('×œ××—×•×§?')) {
            appData.items = appData.items.filter(i => i.id !== id);
            saveDataToCloud();
        }
    }

    function renderKPIs() {
        const est = appData.items.reduce((s, i) => s + (i.est * i.qty), 0);
        const real = appData.items.filter(i => i.purchased).reduce((s, i) => s + (i.real * i.qty), 0);
        document.getElementById('kpi-est').innerText = est.toLocaleString() + ' â‚ª';
        document.getElementById('kpi-real').innerText = real.toLocaleString() + ' â‚ª';
        document.getElementById('kpi-diff').innerText = (real - est).toLocaleString() + ' â‚ª';
        document.getElementById('kpi-count').innerText = appData.items.filter(i => i.purchased).length;
        
        const percent = appData.items.length ? Math.round((appData.items.filter(i => i.purchased).length / appData.items.length) * 100) : 0;
        document.getElementById('prog-bar').style.width = percent + '%';
        document.getElementById('prog-text').innerText = percent + '%';
    }

    // --- ××©×™××•×ª ---

    window.addTask = () => {
        const title = document.getElementById('task-input').value;
        const date = document.getElementById('task-date').value;
        if(!title) return;
        appData.tasks.push({ id: Date.now(), title, date, done: false });
        document.getElementById('task-input').value = '';
        saveDataToCloud();
    };

    window.toggleTask = (id) => {
        const task = appData.tasks.find(t => t.id === id);
        if(task) { task.done = !task.done; saveDataToCloud(); }
    };

    window.deleteTask = (id) => {
        appData.tasks = appData.tasks.filter(t => t.id !== id);
        saveDataToCloud();
    };

    function renderTasks() {
        const list = document.getElementById('task-list');
        list.innerHTML = '';
        appData.tasks.forEach(t => {
            const div = document.createElement('div');
            div.className = "d-flex justify-content-between align-items-center p-2 border-bottom";
            div.innerHTML = `
                <div>
                    <input type="checkbox" ${t.done ? 'checked' : ''} onchange="toggleTask(${t.id})">
                    <span class="${t.done ? 'text-decoration-line-through text-muted' : ''}">${t.title}</span>
                    <small class="d-block text-muted" style="font-size:0.75rem">${t.date || ''}</small>
                </div>
                <button class="btn btn-sm text-danger" onclick="deleteTask(${t.id})">x</button>
            `;
            list.appendChild(div);
        });
    }

    function initCalendar() {
        if(!calendar) {
            calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
                initialView: 'dayGridMonth',
                height: 'auto',
                direction: 'rtl',
                headerToolbar: { left: 'prev,next', center: 'title', right: '' }
            });
            calendar.render();
        }
    }

    const tabEl = document.querySelector('button[data-bs-target="#pills-tasks"]');
    if(tabEl) {
        tabEl.addEventListener('shown.bs.tab', () => calendar && calendar.render());
    }

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
