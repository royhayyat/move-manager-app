<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×”××¢×‘×¨ ×©×œ×™ ğŸ  - ×”×›×œ ×‘××§×•× ××—×“</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(120deg, #f6d365 0%, #fda085 100%);
            --bg-color: #f0f2f5;
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-main: #2d3436;
            --accent-color: #6c5ce7;
        }

        body {
            background-color: var(--bg-color);
            background-image: linear-gradient(120deg, #e0c3fc 0%, #8ec5fc 100%);
            background-attachment: fixed;
            font-family: 'Rubik', sans-serif;
            color: var(--text-main);
            min-height: 100vh;
        }

        /* × ×™×•×•×˜ ×˜××‘×™× */
        .nav-pills .nav-link {
            border-radius: 50px;
            color: #6c5ce7;
            background: rgba(255,255,255,0.6);
            margin-left: 10px;
            font-weight: 500;
            padding: 10px 25px;
            transition: all 0.3s;
        }
        .nav-pills .nav-link.active {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 5px 15px rgba(118, 75, 162, 0.4);
        }

        /* ×›×¨×˜×™×¡×™×•×ª ×•××™×›×œ×™× */
        .glass-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
        }

        /* KPI Cards */
        .kpi-card {
            background: white;
            border: none;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: transform 0.3s ease;
            position: relative;
            overflow: hidden;
            height: 100%;
        }
        .kpi-card:hover { transform: translateY(-5px); }
        .kpi-card::before {
            content: ''; position: absolute; top: 0; right: 0; width: 5px; height: 100%;
            background: var(--primary-gradient);
        }
        .kpi-value { font-size: 1.5rem; font-weight: 700; color: #2d3436; }

        /* ×˜×‘×œ×” */
        .table-container {
            background: white; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); padding: 20px; overflow: hidden;
        }
        .table thead th { background-color: #f8f9fa; border: none; font-size: 0.9rem; }
        .table tbody tr:hover { background-color: #f9f9ff; }
        .table input, .table select { border: 1px solid transparent; background: transparent; border-radius: 8px; width: 100%; }
        .table input:focus, .table select:focus { background: white; border-color: #a29bfe; outline: none; box-shadow: 0 0 0 3px rgba(162,155,254,0.2); }

        /* ×›×¤×ª×•×¨×™× ×•×¤×¨×•×’×¨×¡ ×‘×¨ */
        .btn-custom { border-radius: 50px; font-weight: 500; }
        .btn-primary-custom { background-image: var(--primary-gradient); color: white; border: none; }
        .progress-bar-custom { height: 12px; border-radius: 50px; background: var(--secondary-gradient); transition: width 0.6s ease; }

        /* ×œ×•×— ×©× ×” ×•×¢×™×¦×•×‘ ××©×™××•×ª */
        #calendar { max-width: 100%; font-family: 'Rubik', sans-serif; }
        .fc-toolbar-title { font-size: 1.5em !important; }
        .fc-button-primary { background-color: #6c5ce7 !important; border: none !important; }
        .fc-event { cursor: pointer; border: none; }
        
        /* ×›×¨×˜×™×¡ ××©×™××” */
        .task-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            border-right: 5px solid #ccc;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: all 0.2s;
        }
        .task-card.priority-high { border-right-color: #ff7675; }
        .task-card.priority-medium { border-right-color: #fdcb6e; }
        .task-card.priority-low { border-right-color: #00b894; }
        .task-card.done { opacity: 0.6; text-decoration: line-through; background: #f1f2f6; }
        .task-date-badge { font-size: 0.8rem; background: #dfe6e9; padding: 2px 8px; border-radius: 4px; }

        /* ×× ×™××¦×™×•×ª */
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* ×”×“×¤×¡×” */
        @media print {
            .no-print { display: none !important; }
            .glass-card { box-shadow: none; border: 1px solid #ddd; }
        }
    </style>
</head>
<body>

<div class="container-fluid p-4">
    
    <header class="glass-card d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-0"><i class="fa-solid fa-truck-ramp-box text-primary me-2"></i> ×”××¢×‘×¨ ×©×œ×™</h2>
            <p class="text-muted small mb-0 mt-1">×× ×”×œ×™× ××ª ×”×ª×§×¦×™×‘ ×•×”××©×™××•×ª ×‘×›×™×£</p>
        </div>
        <div class="no-print">
            <button class="btn btn-outline-danger btn-sm btn-custom" onclick="window.print()"><i class="fa-solid fa-print"></i></button>
        </div>
    </header>

    <ul class="nav nav-pills mb-4 justify-content-center no-print" id="pills-tab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="pills-inventory-tab" data-bs-toggle="pill" data-bs-target="#pills-inventory" type="button" role="tab"><i class="fa-solid fa-boxes-packing"></i> ×¨×©×™××ª ×¦×™×•×“ ×•×ª×§×¦×™×‘</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="pills-tasks-tab" data-bs-toggle="pill" data-bs-target="#pills-tasks" type="button" role="tab"><i class="fa-solid fa-calendar-check"></i> ××©×™××•×ª ×•×œ×•×— ×©× ×”</button>
        </li>
    </ul>

    <div class="tab-content" id="pills-tabContent">
        
        <div class="tab-pane fade show active fade-in" id="pills-inventory" role="tabpanel">
            
            <section class="row g-3 mb-4">
                <div class="col-md-2 col-6"><div class="kpi-card p-3"><h6 class="text-muted small">×ª×§×¦×™×‘ ××©×•×¢×¨</h6><div class="kpi-value" id="kpi-est-total">0 â‚ª</div></div></div>
                <div class="col-md-2 col-6"><div class="kpi-card p-3"><h6 class="text-muted small">×‘×•×¦×¢ ×‘×¤×•×¢×œ</h6><div class="kpi-value text-success" id="kpi-real-total">0 â‚ª</div></div></div>
                <div class="col-md-2 col-6"><div class="kpi-card p-3"><h6 class="text-muted small">×¡×˜×˜×•×¡ ×ª×§×¦×™×‘</h6><div class="kpi-value" id="kpi-diff">0 â‚ª</div></div></div>
                <div class="col-md-2 col-6"><div class="kpi-card p-3"><h6 class="text-muted small">×¤×¨×™×˜×™× ×©× ×¨×›×©×•</h6><div class="kpi-value" id="kpi-count-purchased">0</div></div></div>
                <div class="col-md-4 col-12">
                    <div class="kpi-card p-3">
                        <div class="d-flex justify-content-between small text-muted mb-1"><span>××•×›× ×•×ª (×¨×›×©)</span><span id="progress-text">0%</span></div>
                        <div class="progress" style="height: 10px;"><div id="main-progress-bar" class="progress-bar-custom" style="width: 0%"></div></div>
                        <div class="mt-2 d-flex align-items-center justify-content-between">
                            <small>×©×™×œ××ª×™ ××§×“××•×ª:</small>
                            <input type="number" id="down-payment" class="form-control border-0 p-0 fs-6 fw-bold text-primary text-end" style="width: 100px; background: transparent;" value="0" oninput="updateKPIs()">
                        </div>
                    </div>
                </div>
            </section>

            <section class="mb-3 d-flex gap-3 align-items-center bg-white p-3 rounded-4 shadow-sm no-print">
                <input type="text" id="search-input" class="form-control rounded-pill" placeholder="×—×™×¤×•×© ×¦×™×•×“..." style="max-width: 200px;">
                <select id="filter-category" class="form-select rounded-pill" style="max-width: 150px;">
                    <option value="">×”×›×œ</option>
                    <option value="××•×¦×¨×™ ×—×©××œ">âš¡ ××•×¦×¨×™ ×—×©××œ</option>
                    <option value="×¨×™×”×•×˜">ğŸ›‹ï¸ ×¨×™×”×•×˜</option>
                    <option value="××˜×‘×—">ğŸ½ï¸ ××˜×‘×—</option>
                    <option value="×ª××•×¨×”">ğŸ’¡ ×ª××•×¨×”</option>
                    <option value="××—×¨">ğŸ“¦ ××—×¨</option>
                </select>
                <div class="ms-auto">
                    <button class="btn btn-outline-danger btn-custom btn-sm" onclick="deleteSelected()"><i class="fa-solid fa-trash"></i></button>
                    <button class="btn btn-primary-custom btn-custom btn-sm" onclick="addNewRow()"><i class="fa-solid fa-plus"></i> ×”×•×¡×£ ×¦×™×•×“</button>
                    <button class="btn btn-outline-secondary btn-custom btn-sm" onclick="exportCSV()">CSV</button>
                </div>
            </section>

            <div class="table-container table-responsive">
                <table class="table align-middle mb-0" id="items-table">
                    <thead>
                        <tr>
                            <th width="40"><input type="checkbox" id="select-all" class="form-check-input"></th>
                            <th onclick="sortBy('name')" style="cursor: pointer">××•×¦×¨ <i class="fa-solid fa-sort small"></i></th>
                            <th width="120">×§×˜×’×•×¨×™×”</th>
                            <th width="60">×›××•×ª</th>
                            <th width="100">×¦×¤×™</th>
                            <th width="100">×‘×¤×•×¢×œ</th>
                            <th width="130">×ª××¨×™×š</th>
                            <th>×¡×¤×§</th>
                            <th width="70">××—×¨×™×•×ª</th>
                            <th width="50">V</th>
                            <th width="50">ğŸ“</th>
                            <th width="40"></th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>

        <div class="tab-pane fade fade-in" id="pills-tasks" role="tabpanel">
            <div class="row g-4">
                
                <div class="col-lg-8">
                    <div class="glass-card h-100">
                        <div id="calendar"></div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="glass-card h-100 d-flex flex-column">
                        <h5 class="mb-3"><i class="fa-solid fa-list-check text-primary"></i> ××©×™××•×ª ×œ×‘×™×¦×•×¢</h5>
                        
                        <div class="bg-light p-3 rounded-3 mb-3 border">
                            <input type="text" id="task-title" class="form-control form-control-sm mb-2" placeholder="××” ×¦×¨×™×š ×œ×¢×©×•×ª?">
                            <div class="row g-2 mb-2">
                                <div class="col-7">
                                    <input type="date" id="task-date" class="form-control form-control-sm">
                                </div>
                                <div class="col-5">
                                    <select id="task-priority" class="form-select form-select-sm">
                                        <option value="low">×¨×’×™×œ</option>
                                        <option value="medium">×‘×™× ×•× ×™</option>
                                        <option value="high">×“×—×•×£!</option>
                                    </select>
                                </div>
                            </div>
                            <textarea id="task-desc" class="form-control form-control-sm mb-2" rows="2" placeholder="×¤×¨×˜×™× × ×•×¡×¤×™×..."></textarea>
                            <button class="btn btn-primary-custom w-100 btn-sm" onclick="addNewTask()">×”×•×¡×£ ××©×™××”</button>
                        </div>

                        <div id="tasks-list-container" style="overflow-y: auto; flex-grow: 1; max-height: 500px;">
                            </div>
                    </div>
                </div>
            </div>
        </div>

    </div> </div>

<div class="toast-container position-fixed bottom-0 start-0 p-3">
    <div id="liveToast" class="toast align-items-center text-white border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="toast-message"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<input type="file" id="file-upload-input" style="display: none;" accept="image/*,.pdf">

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // --- ×”×’×“×¨×•×ª DB ---
    const DB_NAME = 'MoveManagerProDB';
    const DB_VERSION = 2; // ×’×¨×¡×” 2 ×‘×©×‘×™×œ ×”×©×™× ×•×™×™×
    const STORE_NAME = 'attachments';

    let appState = {
        items: [],
        tasks: [], // ××¢×¨×š ×—×“×© ×œ××©×™××•×ª
        filter: { search: '', category: '', purchasedOnly: false },
        sort: { field: 'id', direction: 'desc' },
        pagination: { currentPage: 1, itemsPerPage: 50 }
    };

    let calendar; // ××©×ª× ×” ×œ×œ×•×— ×©× ×”

    // --- ×©×™×¨×•×ª IndexedDB (×§×‘×¦×™×) ---
    const FileService = {
        db: null,
        async init() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME);
                };
                request.onsuccess = (e) => { this.db = e.target.result; resolve(); };
                request.onerror = (e) => reject(e);
            });
        },
        async saveFile(itemId, file) {
            return new Promise((resolve) => {
                const tx = this.db.transaction([STORE_NAME], 'readwrite');
                tx.objectStore(STORE_NAME).put({ blob: file, name: file.name, type: file.type }, itemId);
                tx.oncomplete = () => resolve();
            });
        },
        async getFile(itemId) {
            return new Promise((resolve) => {
                const tx = this.db.transaction([STORE_NAME], 'readonly');
                const req = tx.objectStore(STORE_NAME).get(itemId);
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => resolve(null);
            });
        },
        async deleteFile(itemId) {
            if(!this.db) return;
            this.db.transaction([STORE_NAME], 'readwrite').objectStore(STORE_NAME).delete(itemId);
        }
    };

    // --- ××ª×—×•×œ ---
    document.addEventListener('DOMContentLoaded', async () => {
        await FileService.init();
        loadData();
        initEventListeners();
        if (appState.items.length === 0 && appState.tasks.length === 0) addDummyData();
        
        renderInventory();
        renderTasks();
        initCalendar();

        // ×ª×™×§×•×Ÿ ×œ×¨×™× ×“×•×¨ ×œ×•×— ×©× ×” ×‘××¢×‘×¨ ×˜××‘×™×
        const tabEl = document.querySelector('button[data-bs-target="#pills-tasks"]');
        tabEl.addEventListener('shown.bs.tab', function () {
            calendar.render();
        });
    });

    // --- × ×™×”×•×œ × ×ª×•× ×™× ---
    function loadData() {
        const savedItems = localStorage.getItem('mm_items_v2');
        const savedTasks = localStorage.getItem('mm_tasks_v2');
        const savedPay = localStorage.getItem('mm_payment_v2');
        
        if (savedItems) appState.items = JSON.parse(savedItems);
        if (savedTasks) appState.tasks = JSON.parse(savedTasks);
        if (savedPay) document.getElementById('down-payment').value = savedPay;
    }

    function saveData() {
        localStorage.setItem('mm_items_v2', JSON.stringify(appState.items));
        localStorage.setItem('mm_tasks_v2', JSON.stringify(appState.tasks));
        localStorage.setItem('mm_payment_v2', document.getElementById('down-payment').value);
        updateKPIs();
        updateCalendarEvents();
    }

    function addDummyData() {
        appState.items = [
            { id: 1, name: '×¡×¤×” ×œ×¡×œ×•×Ÿ', category: '×¨×™×”×•×˜', quantity: 1, estPrice: 4000, realPrice: 0, purchased: false, date: '', vendor: '', warranty: 0, warrantyEnd: '', hasFile: false }
        ];
        appState.tasks = [
            { id: 101, title: '×œ×”×–××™×Ÿ ×”×•×‘×œ×”', date: new Date().toISOString().split('T')[0], priority: 'high', desc: '×œ×”×ª×§×©×¨ ×œ××•×‘×™×œ ××©×”', done: false }
        ];
        saveData();
    }

    // --- ×œ×•×’×™×§×ª ××©×™××•×ª (Tasks) ---
    function addNewTask() {
        const title = document.getElementById('task-title').value;
        const date = document.getElementById('task-date').value;
        const priority = document.getElementById('task-priority').value;
        const desc = document.getElementById('task-desc').value;

        if (!title) { showToast('×—×•×‘×” ×œ×”×–×™×Ÿ ×©× ××©×™××”', 'danger'); return; }

        const newTask = {
            id: Date.now(),
            title,
            date, // ×™×›×•×œ ×œ×”×™×•×ª ×¨×™×§
            priority,
            desc,
            done: false
        };

        appState.tasks.unshift(newTask); // ×”×•×¡×¤×” ×œ×”×ª×—×œ×”
        saveData();
        renderTasks();
        
        // ××™×¤×•×¡ ×©×“×•×ª
        document.getElementById('task-title').value = '';
        document.getElementById('task-desc').value = '';
        showToast('××©×™××” × ×•×¡×¤×”! ğŸ“…', 'success');
    }

    function toggleTask(id) {
        const task = appState.tasks.find(t => t.id === id);
        if (task) {
            task.done = !task.done;
            saveData();
            renderTasks();
        }
    }

    function deleteTask(id) {
        if(confirm('×œ××—×•×§ ××ª ×”××©×™××”?')) {
            appState.tasks = appState.tasks.filter(t => t.id !== id);
            saveData();
            renderTasks();
        }
    }

    function renderTasks() {
        const container = document.getElementById('tasks-list-container');
        container.innerHTML = '';
        
        // ××™×•×Ÿ: ×§×•×“× ×œ× ×‘×•×¦×¢, ××—×¨ ×›×š ×œ×¤×™ ×“×—×™×¤×•×ª
        const sortedTasks = [...appState.tasks].sort((a,b) => {
            if (a.done === b.done) return 0; // ×× ×”×¡×˜×˜×•×¡ ×–×”×”, ×”×¡×“×¨ × ×©××¨ (××¤×©×¨ ×œ×©×¤×¨ ×œ××™×•×Ÿ ×œ×¤×™ ×ª××¨×™×š)
            return a.done ? 1 : -1; // ×œ× ×‘×•×¦×¢ ×œ××¢×œ×”
        });

        sortedTasks.forEach(task => {
            const div = document.createElement('div');
            div.className = `task-card priority-${task.priority} ${task.done ? 'done' : ''}`;
            div.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" ${task.done ? 'checked' : ''} onchange="toggleTask(${task.id})">
                            <label class="form-check-label fw-bold">${task.title}</label>
                        </div>
                        <div class="small text-muted mt-1">${task.desc || ''}</div>
                        ${task.date ? `<div class="mt-2"><span class="task-date-badge"><i class="fa-regular fa-clock"></i> ${task.date}</span></div>` : ''}
                    </div>
                    <button class="btn btn-sm text-danger" onclick="deleteTask(${task.id})"><i class="fa-solid fa-trash"></i></button>
                </div>
            `;
            container.appendChild(div);
        });
    }

    // --- ×œ×•×’×™×§×ª ×œ×•×— ×©× ×” (FullCalendar) ---
    function initCalendar() {
        const calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            direction: 'rtl',
            locale: 'he',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,listWeek'
            },
            height: 'auto',
            events: getCalendarEvents(),
            eventClick: function(info) {
                alert(`××©×™××”: ${info.event.title}\n×ª×™××•×¨: ${info.event.extendedProps.description}`);
            }
        });
        calendar.render();
    }

    function getCalendarEvents() {
        // ×”××¨×ª ××©×™××•×ª ×œ××™×¨×•×¢×™ ×œ×•×— ×©× ×”
        return appState.tasks
            .filter(t => t.date && !t.done) // ××¦×™×’×™× ×¨×§ ××©×™××•×ª ×¢× ×ª××¨×™×š ×©×œ× ×‘×•×¦×¢×•
            .map(t => ({
                title: t.title,
                start: t.date,
                color: t.priority === 'high' ? '#ff7675' : (t.priority === 'medium' ? '#fdcb6e' : '#00b894'),
                extendedProps: { description: t.desc }
            }));
    }

    function updateCalendarEvents() {
        if(calendar) {
            calendar.removeAllEvents();
            calendar.addEventSource(getCalendarEvents());
        }
    }

    // --- ×œ×•×’×™×§×ª ×¦×™×•×“ (Inventory - ××”×§×•×“ ×”×§×•×“×) ---
    function addNewRow() {
        appState.items.unshift({
            id: Date.now(), name: '', category: '××—×¨', quantity: 1, estPrice: 0, realPrice: 0, 
            purchased: false, date: '', vendor: '', warranty: 0, warrantyEnd: '', hasFile: false
        });
        saveData();
        renderInventory();
    }

    function updateItem(id, field, value) {
        const item = appState.items.find(i => i.id === id);
        if (!item) return;

        if (['quantity','estPrice','realPrice','warranty'].includes(field)) value = parseFloat(value) || 0;

        if (field === 'purchased') {
            if (value && (item.realPrice <= 0 || !item.vendor || !item.date)) {
                showToast('×—×¡×¨×™× ×¤×¨×˜×™×: ××—×™×¨, ×¡×¤×§ ××• ×ª××¨×™×š', 'danger');
                renderInventory(); return;
            }
            if (value && item.warranty > 0 && item.date) {
                const d = new Date(item.date);
                d.setMonth(d.getMonth() + item.warranty);
                item.warrantyEnd = d.toISOString().split('T')[0];
            }
        } else if ((field === 'date' || field === 'warranty') && item.purchased) {
             if(field==='date') item.date=value; if(field==='warranty') item.warranty=value;
             const d = new Date(item.date); d.setMonth(d.getMonth() + item.warranty);
             item.warrantyEnd = d.toISOString().split('T')[0];
        } else {
            item[field] = value;
        }
        saveData(); renderInventory();
    }

    function deleteSelected() {
        const checked = document.querySelectorAll('#items-table .form-check-input:checked');
        if(!checked.length || checked[0].id === 'select-all') return;
        if(!confirm('×œ××—×•×§?')) return;
        const ids = Array.from(checked).map(c => +c.value);
        ids.forEach(id => FileService.deleteFile(id));
        appState.items = appState.items.filter(i => !ids.includes(i.id));
        saveData(); renderInventory();
    }

    // --- ×§×‘×¦×™× ---
    let uploadId = null;
    function triggerUpload(id) { uploadId = id; document.getElementById('file-upload-input').click(); }
    document.getElementById('file-upload-input').addEventListener('change', async (e) => {
        if(!e.target.files[0] || !uploadId) return;
        await FileService.saveFile(uploadId, e.target.files[0]);
        const item = appState.items.find(i => i.id === uploadId);
        if(item) { item.hasFile = true; saveData(); renderInventory(); showToast('× ×©××¨', 'success'); }
        e.target.value = '';
    });
    async function downloadFile(id) {
        const f = await FileService.getFile(id);
        if(f) { const u = URL.createObjectURL(f.blob); const a = document.createElement('a'); a.href=u; a.download=f.name; a.click(); }
        else showToast('××™×Ÿ ×§×•×‘×¥', 'danger');
    }

    // --- ×¨×™× ×“×•×¨ ×¦×™×•×“ ×•-KPI ---
    function renderInventory() {
        let data = appState.items;
        const term = appState.filter.search.toLowerCase();
        if(term) data = data.filter(i => (i.name||'').toLowerCase().includes(term));
        if(appState.filter.category) data = data.filter(i => i.category === appState.filter.category);
        
        data.sort((a,b) => (appState.sort.direction === 'asc' ? (a[appState.sort.field]>b[appState.sort.field]?1:-1) : (a[appState.sort.field]<b[appState.sort.field]?1:-1)));

        updateKPIs(data);

        const tbody = document.getElementById('table-body');
        tbody.innerHTML = '';
        data.slice(0, 100).forEach(item => { // ××’×‘×œ×ª ×ª×¦×•×’×”
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="checkbox" class="form-check-input" value="${item.id}"></td>
                <td><input value="${item.name}" onchange="updateItem(${item.id},'name',this.value)" placeholder="×©×..." class="fw-bold"></td>
                <td><select onchange="updateItem(${item.id},'category',this.value)">${['××•×¦×¨×™ ×—×©××œ','×¨×™×”×•×˜','××˜×‘×—','×ª××•×¨×”','××—×¨'].map(o=>`<option value="${o}" ${o===item.category?'selected':''}>${o}</option>`).join('')}</select></td>
                <td><input type="number" value="${item.quantity}" onchange="updateItem(${item.id},'quantity',this.value)" style="width:50px"></td>
                <td><input type="number" value="${item.estPrice}" onchange="updateItem(${item.id},'estPrice',this.value)"></td>
                <td><input type="number" value="${item.realPrice}" onchange="updateItem(${item.id},'realPrice',this.value)"></td>
                <td><input type="date" value="${item.date}" onchange="updateItem(${item.id},'date',this.value)" style="font-size:0.8rem"></td>
                <td><input value="${item.vendor}" onchange="updateItem(${item.id},'vendor',this.value)"></td>
                <td><input type="number" value="${item.warranty}" onchange="updateItem(${item.id},'warranty',this.value)" style="width:40px"></td>
                <td><input type="checkbox" class="form-check-input" ${item.purchased?'checked':''} onchange="updateItem(${item.id},'purchased',this.checked)"></td>
                <td>${item.hasFile ? `<i class="fa-solid fa-check text-success cursor-pointer" onclick="downloadFile(${item.id})"></i>` : `<i class="fa-solid fa-paperclip text-muted cursor-pointer" onclick="triggerUpload(${item.id})"></i>`}</td>
                <td><i class="fa-solid fa-trash text-danger cursor-pointer" onclick="if(confirm('×œ××—×•×§?')){appState.items=appState.items.filter(x=>x.id!==${item.id});saveData();renderInventory();}"></i></td>
            `;
            tbody.appendChild(tr);
        });
    }

    function updateKPIs(data = appState.items) {
        const est = data.reduce((s, i) => s + (i.estPrice * i.quantity), 0);
        const real = data.filter(i => i.purchased).reduce((s, i) => s + (i.realPrice * i.quantity), 0);
        const diff = real - est;
        
        document.getElementById('kpi-est-total').innerText = fmt(est);
        document.getElementById('kpi-real-total').innerText = fmt(real);
        const diffEl = document.getElementById('kpi-diff');
        diffEl.innerText = fmt(Math.abs(diff));
        diffEl.style.color = diff > 0 ? '#d63031' : '#00b894';
        diffEl.innerText = (diff > 0 ? '+' : '-') + diffEl.innerText;
        document.getElementById('kpi-count-purchased').innerText = data.filter(i => i.purchased).length;

        // Progress
        const prog = data.length ? Math.round((data.filter(i=>i.purchased).length/data.length)*100) : 0;
        document.getElementById('main-progress-bar').style.width = prog + '%';
        document.getElementById('progress-text').innerText = prog + '%';
    }

    const fmt = n => new Intl.NumberFormat('he-IL', { style: 'currency', currency: 'ILS', maximumFractionDigits: 0 }).format(n);
    function showToast(msg, type='info') {
        const t = document.getElementById('liveToast');
        t.className = `toast align-items-center text-white border-0 bg-${type === 'danger' ? 'danger' : 'success'}`;
        document.getElementById('toast-message').innerText = msg;
        new bootstrap.Toast(t).show();
    }
    
    // ××™×¨×•×¢×™× ×’×œ×•×‘×œ×™×™×
    function initEventListeners() {
        document.getElementById('search-input').addEventListener('input', (e) => { appState.filter.search = e.target.value; renderInventory(); });
        document.getElementById('filter-category').addEventListener('change', (e) => { appState.filter.category = e.target.value; renderInventory(); });
        document.getElementById('select-all').addEventListener('change', (e) => document.querySelectorAll('#items-table input[type="checkbox"]').forEach(c => c.checked = e.target.checked));
    }
    function sortBy(f) { appState.sort.field=f; appState.sort.direction=appState.sort.direction==='asc'?'desc':'asc'; renderInventory(); }
    
    function exportCSV() {
        let csv = "\uFEFF×©×,×§×˜×’×•×¨×™×”,×›××•×ª,××—×™×¨ ××©×•×¢×¨,××—×™×¨ ×××™×ª×™,×¡×¤×§\n";
        appState.items.forEach(i => csv += `"${i.name}","${i.category}",${i.quantity},${i.estPrice},${i.realPrice},"${i.vendor}"\n`);
        const a = document.createElement('a'); a.href='data:text/csv;charset=utf-8,'+encodeURI(csv); a.download='moving_list.csv'; a.click();
    }

    // ×—×©×™×¤×” ×œ-Window
    window.addNewRow = addNewRow; window.updateItem = updateItem; window.deleteSelected = deleteSelected;
    window.triggerUpload = triggerUpload; window.downloadFile = downloadFile; window.sortBy = sortBy;
    window.updateKPIs = updateKPIs; window.exportCSV = exportCSV;
    window.addNewTask = addNewTask; window.deleteTask = deleteTask; window.toggleTask = toggleTask;

</script>
</body>
</html>
