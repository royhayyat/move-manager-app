<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <title>注专 砖 </title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>

    <style>
        :root { --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%); --bg-color: #f0f2f5; }
        body { background: var(--bg-color) linear-gradient(120deg, #e0c3fc 0%, #8ec5fc 100%) fixed; font-family: 'Rubik', sans-serif; min-height: 100vh; padding-bottom: 80px; -webkit-tap-highlight-color: transparent; }
        
        /* Login Screen */
        #auth-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index: 9999; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .auth-box { background: white; padding: 30px; border-radius: 20px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        
        /* Cards & Buttons */
        .glass-card { background: rgba(255,255,255,0.98); border-radius: 16px; padding: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .kpi-card { background: white; border-radius: 12px; padding: 12px; height: 100%; box-shadow: 0 2px 8px rgba(0,0,0,0.05); text-align: center; border: 1px solid #f0f0f0; }
        .kpi-val { font-size: 1.2rem; font-weight: 700; color: #2d3436; margin-top: 5px; }
        .btn-custom { border-radius: 50px; background-image: var(--primary-gradient); color: white; border: none; padding: 10px 0; width: 100%; font-weight: 500; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
        .nav-pills .nav-link { border-radius: 50px; margin: 0 5px; font-size: 0.9rem; transition: all 0.3s; }
        .nav-pills .nav-link.active { background: var(--primary-gradient); box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }

        /* Sub Items Table */
        .sub-items-container { background: #f8f9fa; border-radius: 10px; padding: 10px; margin-top: 10px; border: 1px dashed #ced4da; }
        .sub-row input { background: #fff !important; border: 1px solid #ddd !important; font-size: 0.85rem !important; }

        /* --- Mobile Table Fixes --- */
        @media (max-width: 768px) {
            .container-fluid { padding: 12px; }
            .table-main-head { display: none; } /* Hide main headers only */
            
            /* Card Style for Rows */
            .item-row-card {
                background: white;
                margin-bottom: 20px;
                border-radius: 16px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.03);
                border: 1px solid #f0f0f0;
                padding: 15px;
                display: flex;
                flex-direction: column;
                position: relative;
            }
            
            .item-row-content { display: flex; flex-direction: column; gap: 10px; }
            .mobile-cell { display: flex; justify-content: space-between; align-items: center; width: 100%; }
            .mobile-cell::before { content: attr(data-label); font-weight: 600; color: #636e72; font-size: 0.9rem; }
            
            .table input, .table select {
                text-align: right; background: #f8f9fa !important;
                border-radius: 8px; padding: 8px 12px;
                width: 60% !important; border: 1px solid #eee !important;
            }
            
            /* Delete Button Mobile */
            .btn-action-group { margin-top: 15px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #eee; padding-top: 10px;}
        }

        @media (min-width: 769px) {
            .item-row-card { display: table-row; }
            .item-row-content { display: contents; }
            .mobile-cell { display: table-cell; vertical-align: middle; padding: 8px; }
            .mobile-cell::before { display: none; }
            .btn-action-group { display: none; } /* On desktop we use the table cell actions */
        }

        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 10px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fc-toolbar-title { font-size: 1.1rem !important; }
        .fc-button { font-size: 0.8rem !important; padding: 4px 8px !important; }
        
        .calculated-field { background-color: #e9ecef !important; color: #495057; cursor: not-allowed; }
    </style>
</head>
<body>

<div id="auth-screen">
    <div class="auth-box">
        <h2 class="mb-4 text-primary fw-bold"> 注专 砖</h2>
        <div id="login-form">
            <input type="email" id="email" class="form-control mb-3 p-3" placeholder="">
            <input type="password" id="password" class="form-control mb-4 p-3" placeholder="住住">
            <button class="btn btn-custom" onclick="handleAuth('login')">转专</button>
            <div class="mt-4 small">砖 ? <a href="#" onclick="toggleMode()" class="fw-bold">爪专 砖</a></div>
        </div>
        <div id="register-form" style="display:none">
            <input type="email" id="reg-email" class="form-control mb-3 p-3" placeholder="">
            <input type="password" id="reg-pass" class="form-control mb-4 p-3" placeholder="住住 (6+ 转)">
            <button class="btn btn-custom" onclick="handleAuth('register')">专砖</button>
            <div class="mt-4 small">专砖 专? <a href="#" onclick="toggleMode()" class="fw-bold">转专</a></div>
        </div>
        <div class="loader" id="auth-loader"></div>
        <div id="auth-msg" class="text-danger mt-3 small fw-bold"></div>
    </div>
</div>

<div class="container-fluid" id="app-content" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-3 mt-3 px-2">
        <div><h4 class="mb-0 fw-bold">注专 砖</h4><small class="text-muted" style="font-size: 0.75rem" id="user-display"></small></div>
        <button class="btn btn-light btn-sm rounded-circle shadow-sm" style="width:35px;height:35px" onclick="logout()"><i class="fa-solid fa-right-from-bracket text-danger"></i></button>
    </div>

    <ul class="nav nav-pills nav-fill mb-3" id="pills-tab">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-items"> 爪 转拽爪</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-tasks"> 砖转</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="tab-items">
            <div class="row g-2 mb-3">
                <div class="col-6"><div class="kpi-card"><div class="small text-muted">转拽爪 砖注专</div><div class="kpi-val" id="kpi-est">0</div></div></div>
                <div class="col-6"><div class="kpi-card"><div class="small text-muted">爪转 驻注</div><div class="kpi-val text-success" id="kpi-real">0</div></div></div>
            </div>

            <div class="glass-card p-2">
                <div class="d-flex justify-content-between align-items-center mb-3 px-2 gap-2">
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle rounded-pill" type="button" data-bs-toggle="dropdown">
                            <i class="fa-solid fa-filter"></i> 住
                        </button>
                        <ul class="dropdown-menu text-end">
                            <li><a class="dropdown-item" href="#" onclick="setFilter('all')"></a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="setFilter('purchased')">专砖 </a></li>
                            <li><a class="dropdown-item" href="#" onclick="setFilter('not_purchased')">专 专砖</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="setFilter('专')">专</a></li>
                            <li><a class="dropdown-item" href="#" onclick="setFilter('砖')">砖</a></li>
                            <li><a class="dropdown-item" href="#" onclick="setFilter('')"></a></li>
                            <li><a class="dropdown-item" href="#" onclick="setFilter('专')">专</a></li>
                        </ul>
                    </div>
                    <span id="current-filter-label" class="badge bg-light text-dark ms-2"></span>
                    <button class="btn btn-primary btn-sm rounded-pill px-3 shadow-sm ms-auto" onclick="addItem()">+ 驻专 砖</button>
                </div>

                <div id="items-list"></div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-tasks">
            <div class="glass-card">
                <div id="calendar" class="mb-4"></div>
                <h6 class="fw-bold mb-3 border-bottom pb-2">住祝 砖</h6>
                <div class="d-flex gap-2 mb-3">
                    <input type="text" id="task-desc" class="form-control" placeholder=" 注砖转?">
                    <input type="date" id="task-date" class="form-control" style="width: 130px;">
                </div>
                <button class="btn btn-custom mb-3" onclick="addTask()">住祝 砖</button>
                <div id="tasks-list" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC_EkuSJuu2H62VthOLN3086V6GdnVuzFU",
      authDomain: "my-moving-app-b5884.firebaseapp.com",
      projectId: "my-moving-app-b5884",
      storageBucket: "my-moving-app-b5884.firebasestorage.app",
      messagingSenderId: "90331727782",
      appId: "1:90331727782:web:fb0f70ac7cae3dc2adb167"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let currentUser = null;
    let appData = { items: [], tasks: [] };
    let calendar;
    let currentFilter = 'all';

    // Auth
    window.toggleMode = () => {
        const login = document.getElementById('login-form');
        const reg = document.getElementById('register-form');
        login.style.display = login.style.display === 'none' ? 'block' : 'none';
        reg.style.display = reg.style.display === 'none' ? 'block' : 'none';
    }
    window.handleAuth = async (mode) => {
        const email = document.getElementById(mode === 'login' ? 'email' : 'reg-email').value;
        const pass = document.getElementById(mode === 'login' ? 'password' : 'reg-pass').value;
        const msg = document.getElementById('auth-msg');
        const loader = document.getElementById('auth-loader');
        msg.innerText = ''; loader.style.display = 'block';
        try {
            if (mode === 'login') await signInWithEmailAndPassword(auth, email, pass);
            else await createUserWithEmailAndPassword(auth, email, pass);
        } catch (error) {
            msg.innerText = "砖: " + error.message;
            loader.style.display = 'none';
        }
    };
    window.logout = () => signOut(auth);
    onAuthStateChanged(auth, (user) => {
        document.getElementById('auth-loader').style.display = 'none';
        if (user) {
            currentUser = user;
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
            document.getElementById('user-display').innerText = user.email;
            initData();
        } else {
            document.getElementById('auth-screen').style.display = 'flex';
            document.getElementById('app-content').style.display = 'none';
        }
    });

    // Data
    function initData() {
        onSnapshot(doc(db, "users", currentUser.uid), (snap) => {
            if (snap.exists()) {
                appData = snap.data();
                if(!appData.items) appData.items = [];
                if(!appData.tasks) appData.tasks = [];
                // Ensure subItems array exists on older data
                appData.items.forEach(i => { if(!i.subItems) i.subItems = []; });
            } else { saveData(); }
            renderAll();
        });
        initCalendar();
    }
    async function saveData() {
        if (!currentUser) return;
        await setDoc(doc(db, "users", currentUser.uid), appData);
    }

    // --- Logic for Items & SubItems ---

    window.addItem = () => { 
        appData.items.unshift({ 
            id: Date.now(), 
            name: '', 
            category: '专', 
            qty: 1, 
            est: 0, 
            real: 0, 
            purchased: false,
            subItems: [] 
        }); 
        saveData(); 
    };

    window.updateItem = (id, field, val) => {
        const i = appData.items.find(x => x.id === id);
        if (i) {
            if(field === 'purchased') i.purchased = val;
            else if(['qty','est','real'].includes(field)) i[field] = Number(val);
            else i[field] = val;
            saveData();
        }
    };

    window.deleteItem = (id) => { 
        if(confirm('拽 转 驻专?')) { 
            appData.items = appData.items.filter(x => x.id !== id); 
            saveData(); 
        } 
    };

    // Sub Items Logic
    window.addSubItem = (parentId) => {
        const parent = appData.items.find(x => x.id === parentId);
        if(parent) {
            if(!parent.subItems) parent.subItems = [];
            parent.subItems.push({ id: Date.now(), name: '', cost: 0, qty: 1 });
            saveData();
        }
    }

    window.updateSubItem = (parentId, subId, field, val) => {
        const parent = appData.items.find(x => x.id === parentId);
        if(parent && parent.subItems) {
            const sub = parent.subItems.find(s => s.id === subId);
            if(sub) {
                sub[field] = field === 'name' ? val : Number(val);
                saveData();
            }
        }
    }

    window.deleteSubItem = (parentId, subId) => {
        const parent = appData.items.find(x => x.id === parentId);
        if(parent && parent.subItems) {
            parent.subItems = parent.subItems.filter(s => s.id !== subId);
            saveData();
        }
    }

    // Filter Logic
    window.setFilter = (filter) => {
        currentFilter = filter;
        const labelMap = { 'all': '', 'purchased': '专砖', 'not_purchased': '专 专砖', '专': '专', '砖': '砖', '': '', '专': '专' };
        document.getElementById('current-filter-label').innerText = labelMap[filter] || filter;
        renderAll();
    }

    // Task Logic
    window.addTask = () => {
        const title = document.getElementById('task-desc').value;
        const date = document.getElementById('task-date').value;
        if(title) { appData.tasks.push({ id: Date.now(), title, date, done: false }); document.getElementById('task-desc').value = ''; saveData(); }
    };
    window.deleteTask = (id) => { appData.tasks = appData.tasks.filter(t => t.id !== id); saveData(); };
    window.toggleTask = (id) => { const t = appData.tasks.find(x => x.id === id); if(t) { t.done = !t.done; saveData(); } };

    // --- Rendering ---

    function renderAll() {
        const list = document.getElementById('items-list');
        
        // 1. Filter items
        let filteredItems = appData.items;
        if (currentFilter === 'purchased') filteredItems = appData.items.filter(i => i.purchased);
        else if (currentFilter === 'not_purchased') filteredItems = appData.items.filter(i => !i.purchased);
        else if (currentFilter !== 'all') filteredItems = appData.items.filter(i => i.category === currentFilter);

        // 2. Render List
        if(filteredItems.length === 0) {
            list.innerHTML = '<div class="text-center text-muted py-5"> 驻专 爪</div>';
        } else {
            list.innerHTML = `
            <table class="table table-borderless m-0 w-100">
                <thead class="text-muted small bg-light rounded table-main-head">
                    <tr><th></th><th>砖</th><th width="80">拽专</th><th width="60">转</th><th width="80">爪驻</th><th width="80">驻注</th><th width="50">专砖</th><th width="30"></th></tr>
                </thead>
                <tbody>
                    ${filteredItems.map(i => {
                        const hasSub = i.subItems && i.subItems.length > 0;
                        // Calculate totals from subitems if they exist
                        const calculatedReal = hasSub ? i.subItems.reduce((acc, s) => acc + (s.cost * s.qty), 0) : i.real;
                        
                        return `
                        <tr class="item-row-card">
                            <td class="mobile-cell" data-label="驻专">
                                <button class="btn btn-sm btn-outline-primary rounded-circle" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${i.id}">
                                    <i class="fa-solid fa-list-ul"></i>
                                </button>
                            </td>
                            <td class="mobile-cell" data-label="砖 爪专">
                                <input class="form-control form-control-sm border-0 bg-light" value="${i.name}" onchange="updateItem(${i.id},'name',this.value)" placeholder="住 砖...">
                            </td>
                            <td class="mobile-cell" data-label="拽专">
                                <select class="form-select form-select-sm border-0 bg-light" onchange="updateItem(${i.id},'category',this.value)">
                                    ${['专','砖','','专'].map(c=>`<option ${c===i.category?'selected':''}>${c}</option>`).join('')}
                                </select>
                            </td>
                            <td class="mobile-cell" data-label="转">
                                <input type="number" class="form-control form-control-sm border-0 bg-light" value="${i.qty}" onchange="updateItem(${i.id},'qty',this.value)" ${hasSub ? 'disabled' : ''}>
                            </td>
                            <td class="mobile-cell" data-label="专 砖注专">
                                <input type="number" class="form-control form-control-sm border-0 bg-light" value="${i.est}" onchange="updateItem(${i.id},'est',this.value)">
                            </td>
                            <td class="mobile-cell" data-label="专 驻注">
                                <input type="number" class="form-control form-control-sm border-0 bg-light ${hasSub ? 'calculated-field':''}" 
                                       value="${calculatedReal}" 
                                       onchange="updateItem(${i.id},'real',this.value)" 
                                       ${hasSub ? 'readonly' : ''}>
                            </td>
                            <td class="mobile-cell" data-label=" 专砖?">
                                <div class="form-check d-flex justify-content-end justify-content-md-center">
                                    <input type="checkbox" class="form-check-input" ${i.purchased?'checked':''} onchange="updateItem(${i.id},'purchased',this.checked)">
                                </div>
                            </td>
                            <td class="text-end d-none d-md-table-cell" style="border:none !important">
                                <i class="fa-solid fa-trash text-danger" style="cursor:pointer" onclick="deleteItem(${i.id})"></i>
                            </td>
                            <div class="btn-action-group d-md-none">
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteItem(${i.id})"><i class="fa-solid fa-trash"></i> 拽 驻专</button>
                            </div>
                        </tr>
                        
                        <tr>
                            <td colspan="8" class="p-0 border-0">
                                <div class="collapse" id="collapse-${i.id}">
                                    <div class="sub-items-container mx-2 mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <small class="fw-bold text-primary">驻专 转转-爪专 注专 ${i.name || '驻专'}:</small>
                                            <button class="btn btn-sm btn-primary py-0" onclick="addSubItem(${i.id})">+ 住祝</button>
                                        </div>
                                        ${hasSub ? `
                                            <div class="row g-1 fw-bold small text-muted text-center mb-1">
                                                <div class="col-5">砖</div>
                                                <div class="col-2">'</div>
                                                <div class="col-3">专</div>
                                                <div class="col-2"></div>
                                            </div>
                                        ` : '<div class="text-muted small text-center"> 转转-驻专</div>'}
                                        
                                        ${(i.subItems || []).map(sub => `
                                            <div class="row g-1 mb-1 align-items-center sub-row">
                                                <div class="col-5"><input type="text" class="form-control form-control-sm" value="${sub.name}" placeholder="砖.." onchange="updateSubItem(${i.id}, ${sub.id}, 'name', this.value)"></div>
                                                <div class="col-2"><input type="number" class="form-control form-control-sm px-1" value="${sub.qty}" onchange="updateSubItem(${i.id}, ${sub.id}, 'qty', this.value)"></div>
                                                <div class="col-3"><input type="number" class="form-control form-control-sm px-1" value="${sub.cost}" onchange="updateSubItem(${i.id}, ${sub.id}, 'cost', this.value)"></div>
                                                <div class="col-2 text-center"><i class="fa-solid fa-xmark text-danger" style="cursor:pointer" onclick="deleteSubItem(${i.id}, ${sub.id})"></i></div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </td>
                        </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>`;
        }

        // 3. KPI Calculation (Fixes for Actuals)
        let totalEst = 0;
        let totalReal = 0;

        appData.items.forEach(i => {
            // Est
            totalEst += (i.est * i.qty);
            
            // Real Logic:
            // If item has subItems, sum them up. If not, use item.real * item.qty
            let itemRealCost = 0;
            if (i.subItems && i.subItems.length > 0) {
                itemRealCost = i.subItems.reduce((acc, sub) => acc + (sub.cost * sub.qty), 0);
            } else {
                itemRealCost = i.real * i.qty;
            }

            // Only add to Total Real if purchased is TRUE
            if (i.purchased) {
                totalReal += itemRealCost;
            }
        });

        document.getElementById('kpi-est').innerText = totalEst.toLocaleString();
        document.getElementById('kpi-real').innerText = totalReal.toLocaleString();

        // Tasks Render
        document.getElementById('tasks-list').innerHTML = appData.tasks.map(t => `
            <div class="glass-card p-2 mb-2 d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-2">
                    <input type="checkbox" class="form-check-input" ${t.done?'checked':''} onchange="toggleTask(${t.id})">
                    <div>
                        <div class="${t.done?'text-decoration-line-through text-muted':''} fw-bold">${t.title}</div>
                        <div class="small text-muted">${t.date||''}</div>
                    </div>
                </div>
                <button class="btn btn-sm text-danger" onclick="deleteTask(${t.id})"><i class="fa-solid fa-xmark"></i></button>
            </div>
        `).join('');

        if(calendar) {
            calendar.removeAllEvents();
            calendar.addEventSource(appData.tasks.filter(t=>t.date).map(t => ({ title: t.title, start: t.date, color: t.done?'#ccc':'#667eea' })));
        }
    }

    function initCalendar() {
        if(calendar) return;
        const isMobile = window.innerWidth < 768;
        calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
            initialView: isMobile ? 'listMonth' : 'dayGridMonth',
            headerToolbar: { left: 'prev,next', center: 'title', right: '' },
            height: 'auto', direction: 'rtl', locale: 'he',
            buttonText: { list: '专砖' }
        });
        calendar.render();
    }
    document.querySelector('button[data-bs-target="#tab-tasks"]').addEventListener('shown.bs.tab', () => calendar && calendar.render());

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
